{% extends 'base.html' %}

{% block title %}Amazon Request List | MarketInsight{% endblock %}

{% block content %}
    <h2 class="mb-4 text-info">Scrap Requests</h2>
    <ul class="list-group">
      {% for scrap_request in scrap_requests %}
        <li class="list-group-item">
          <div class="row">
            <div class="col-md-9">
              <h4>
                <span style="background-color: #dff0d8; padding: 5px; border-radius: 5px;">
                  {{ scrap_request.country_code }}
                </span>
                <span style="background-color: #d9edf7; padding: 5px; border-radius: 5px;">
                  {{ scrap_request.request_reason }}
                </span>
                - {{ scrap_request.request_date }}
              </h4>
            </div>
            <div class="col-md-3 text-right">
              <span id="status-{{ scrap_request.id }}" class="status">
                {% if scrap_request.status == 'COMPLETED' %}
                  <i class="fas fa-check-circle text-success" style="font-size: 24px;"></i>
                {% else %}
                  <i class="fas fa-circle-notch fa-spin" data-pk="{{ scrap_request.id }}" style="font-size: 24px;"></i>
                {% endif %}
              </span>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>

    <script>
      if(document.title === "Amazon Request List | MarketInsight"){
        document.querySelectorAll('i.fa-circle-notch').forEach(circle => {
          const pk = circle.dataset.pk;
          const statusElement = document.getElementById(`status-${pk}`);
          const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
          const ws_url = `${ws_scheme}://${window.location.host}/ws/status/${pk}/`;
          const socket = new WebSocket(ws_url);

          socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.status === 'COMPLETED') {
              statusElement.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 24px;"></i>';
            } else if (data.status === 'FAILED') {
              statusElement.innerHTML = '<i class="fas fa-times-circle text-danger" style="font-size: 24px;"></i>';
            } else {
              statusElement.innerHTML = '<i class="fas fa-circle-notch fa-spin" data-pk="' + pk + '" style="font-size: 24px;"></i>';
            }
          };
        });
      }
    </script>
{% endblock %}